<!DOCTYPE html>
<html>

<head>
  <title>Survey</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <div class="container" id="surveyContainer">
    <div id="pageContent"></div>
    <div id="navigation">
      <button id="prevPage" disabled>Previous</button>
      <button id="nextPage" disabled>Next</button>
    </div>
  </div>

  <script>
    const surveyContainer = document.getElementById("surveyContainer");
    const pageContent = document.getElementById("pageContent");
    const prevPageButton = document.getElementById("prevPage");
    const nextPageButton = document.getElementById("nextPage");

    const uniqueUrl = window.location.pathname.split("/").pop();
    let currentPage = 0;
    let surveyData = null;

    function getFormData() {
      const formDataString = sessionStorage.getItem(`formData_${uniqueUrl}`);
      return formDataString ? JSON.parse(formDataString) : {};
    }

    function setFormData(formData) {
      sessionStorage.setItem(
        `formData_${uniqueUrl}`,
        JSON.stringify(formData)
      );
    }

    function clearFormData() {
      sessionStorage.removeItem(`formData_${uniqueUrl}`);
    }

    function displayPage(pageIndex) {
  if (surveyData && pageIndex >= 0 && pageIndex < surveyData.pages.length) {
    const page = surveyData.pages[pageIndex];
    pageContent.innerHTML = "";

    // Display the page name
    const pageNameHeading = document.createElement("h2");
    pageNameHeading.textContent = page.pageName || `Page ${pageIndex + 1}`;
    pageContent.appendChild(pageNameHeading);

    if (page.figmaUrl) {
      const figmaIframe = document.createElement("iframe");
      figmaIframe.src = page.figmaUrl;
      figmaIframe.width = "100%";
      figmaIframe.height = "500px";
      figmaIframe.allowFullscreen = true;
      pageContent.appendChild(figmaIframe);
    }

    const form = document.createElement("form");
    form.id = `form_page${pageIndex + 1}`;

    page.components.forEach((component) => {
      if (component.label) {
        const label = document.createElement("label");
        label.textContent = component.label;
        form.appendChild(label);
      }

      const inputName = `${component.type}_page${pageIndex + 1}[]`;
      let input;

      if (component.type === "input") {
        input = document.createElement("input");
        input.type = "text";
      } else if (component.type === "textarea") {
        input = document.createElement("textarea");
      } else if (component.type === "dropdown") {
        input = document.createElement("select");

        // Add default option
        const defaultOption = document.createElement("option");
        defaultOption.value = ""; // Empty value for the default option
        defaultOption.text = "Select an option";
        defaultOption.disabled = true; // Make it unselectable
        defaultOption.selected = true; // Set it as the default selected option
        input.appendChild(defaultOption);

        // Add other options
        component.options.forEach((optionValue) => {
          const option = document.createElement("option");
          option.value = optionValue;
          option.text = optionValue;
          input.appendChild(option);
        });
      }

      input.name = inputName;

      if (performance.navigation.type !== performance.navigation.TYPE_RELOAD) {
        const formData = getFormData();
        if (formData[pageIndex] && formData[pageIndex][inputName]) {
          input.value = formData[pageIndex][inputName];
        }
      }

      input.addEventListener("change", () => {
        const currentFormData = getFormData();
        if (!currentFormData[pageIndex]) {
          currentFormData[pageIndex] = {};
        }
        currentFormData[pageIndex][inputName] = input.value;
        setFormData(currentFormData);
      });

      form.appendChild(input);
    });

    pageContent.appendChild(form);

    currentPage = pageIndex;
    prevPageButton.disabled = currentPage === 0;
    nextPageButton.disabled = currentPage === surveyData.pages.length - 1;
    nextPageButton.style.display =
      currentPage === surveyData.pages.length - 1
        ? "none"
        : "inline-block";

    if (currentPage === surveyData.pages.length - 1) {
      const submitButton = document.createElement("button");
      submitButton.type = "submit";
      submitButton.textContent = "Submit Survey";
      form.appendChild(submitButton);

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        const finalFormData = getFormData();

        const formattedResponses = Object.entries(finalFormData).map(
          ([pageIndex, pageData]) => ({
            pageIndex: parseInt(pageIndex),
            answers: Object.entries(pageData).map(
              ([componentId, value]) => ({
                componentId,
                value,
              })
            ),
          })
        );

        try {
          const response = await fetch(
            `/surveys/${surveyData._id}/submit`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                responses: formattedResponses,
                completed: true,
              }),
            }
          );

          if (response.ok) {
            alert("Survey submitted successfully!");
            clearFormData();
            window.location.href = "/thankyou.html";
          } else {
            alert("Error submitting survey");
          }
        } catch (error) {
          console.error("Error:", error);
          alert("Error submitting survey");
        }
      });
    }
  }
}

    // Clear form data only on page refresh
    window.addEventListener("beforeunload", (event) => {
      if (
        performance.navigation.type === performance.navigation.TYPE_RELOAD
      ) {
        clearFormData();
      }
    });

    prevPageButton.addEventListener("click", () => {
      if (currentPage > 0) {
        displayPage(currentPage - 1);
      }
    });

    nextPageButton.addEventListener("click", () => {
      if (surveyData && currentPage < surveyData.pages.length - 1) {
        displayPage(currentPage + 1);
      }
    });

    fetch(`/s/${uniqueUrl}`)
      .then((response) => {
        if (!response.ok) {
          throw new Error("Network response was not ok");
        }
        return response.json();
      })
      .then((survey) => {
        surveyData = survey;
        document.title = surveyData.name || "Survey";
        if (surveyData.pages.length > 0) {
          displayPage(0);
        } else {
          pageContent.innerHTML = "<p>No pages in this survey.</p>";
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        pageContent.innerHTML = "<p>Error loading survey.</p>";
      });
  </script>
</body>

</html>